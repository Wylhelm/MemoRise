{% extends "base.html" %}

{% block content %}
<h1>Retrieve Memories</h1>
<form method="POST" class="mb-4">
    <div class="form-row">
        <div class="form-group col-md-4">
            <label for="keyword">Keyword:</label>
            <input type="text" class="form-control" id="keyword" name="keyword">
        </div>
        <div class="form-group col-md-4">
            <label for="category">Category:</label>
            <input type="text" class="form-control" id="category" name="category">
        </div>
        <div class="form-group col-md-4">
            <label for="sentiment">Sentiment:</label>
            <select class="form-control" id="sentiment" name="sentiment">
                <option value="">All</option>
                <option value="positive">Positive</option>
                <option value="neutral">Neutral</option>
                <option value="negative">Negative</option>
            </select>
        </div>
    </div>
    <div class="form-row">
        <div class="form-group col-md-4">
            <label for="start_date">Start Date:</label>
            <input type="date" class="form-control" id="start_date" name="start_date">
        </div>
        <div class="form-group col-md-4">
            <label for="end_date">End Date:</label>
            <input type="date" class="form-control" id="end_date" name="end_date">
        </div>
        <div class="form-group col-md-4">
            <label for="language">Language:</label>
            <input type="text" class="form-control" id="language" name="language">
        </div>
    </div>
    <button type="submit" class="btn btn-primary">Search</button>
</form>

{% if memories %}
    {% for memory in memories %}
        <div class="card mb-3">
            <div class="card-body">
                <h5 class="card-title">Memory ID: {{ memory.id }}</h5>
                <h6 class="card-subtitle mb-2 text-muted">{{ memory.timestamp }}</h6>
                <p class="card-text">{{ memory.content }}</p>
                <p><strong>Category:</strong> {{ memory.category }}</p>
                <p><strong>Sentiment:</strong> {{ memory.sentiment }}</p>
                <p><strong>Language:</strong> {{ memory.language }} ({{ memory.language_code }})</p>
                <p><strong>Key Phrases:</strong> 
                    {% set key_phrases = memory.key_phrases | from_json %}
                    {% if key_phrases is string %}
                        {{ key_phrases }}
                    {% else %}
                        {{ ', '.join(key_phrases) }}
                    {% endif %}
                </p>
                <p><strong>Entities:</strong> 
                    {% set entities = memory.entities | from_json %}
                    {% if entities is string %}
                        {{ entities }}
                    {% elif entities is iterable %}
                        {% for entity in entities %}
                            {% if entity is mapping %}
                                {{ entity.get('text', '') }} ({{ entity.get('category', '') }})
                            {% elif entity is string %}
                                {{ entity }}
                            {% elif entity is iterable and entity is not string %}
                                {% set entity_text = entity[0] if entity else '' %}
                                {% set entity_category = entity[1] if entity|length > 1 else '' %}
                                {{ entity_text }}
                                {%- if entity_category and entity_category != entity_text and entity_category != '' %} ({{ entity_category }}){% endif %}
                            {% else %}
                                {{ entity }}
                            {% endif %}
                            {% if not loop.last %}, {% endif %}
                        {% endfor %}
                    {% else %}
                        Unable to display entities
                    {% endif %}
                </p>
                <a href="{{ url_for('memory.update_memory_route', memory_id=memory.id) }}" class="btn btn-primary btn-sm">Edit</a>
                <form action="{{ url_for('memory.delete_memory_route', memory_id=memory.id) }}" method="POST" style="display: inline;">
                    <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure you want to delete this memory?')">Delete</button>
                </form>
            </div>
        </div>
    {% endfor %}
{% else %}
    <p>No memories found.</p>
{% endif %}
{% endblock %}
