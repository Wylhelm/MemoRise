{% extends "base.html" %}


{% block content %}
<h1>Chat with Your Memories</h1>
<div id="chat-container">
    <div id="chat-history"></div>
    <form id="chat-form">
        <div class="form-group">
            <input type="text" id="query" name="query" class="form-control" placeholder="Ask a question about your memories..." required>
        </div>
        <button type="submit" class="btn btn-success">Send</button>
    </form>
</div>

<script>
let chatHistory = [];

function formatResponse(text) {
    // Handle numbered lists
    text = text.replace(/^\d+\.\s/gm, '<br>$&');
    
    // Handle bullet points
    text = text.replace(/^[-*]\s/gm, '<br>â€¢ ');
    
    // Handle bold text
    text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    
    // Handle italic text
    text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
    
    // Handle line breaks
    text = text.replace(/\n/g, '<br>');
    
    return text;
}

document.getElementById('chat-form').addEventListener('submit', function(e) {
    e.preventDefault();
    var query = document.getElementById('query').value;
    var chatHistoryDiv = document.getElementById('chat-history');
    
    chatHistoryDiv.innerHTML += '<p><strong>You:</strong> ' + query + '</p>';
    
    fetch('/chat_with_memories', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            query: query,
            chat_history: chatHistory
        })
    })
    .then(response => {
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let aiResponse = '';
        let aiResponseElement = document.createElement('p');
        aiResponseElement.innerHTML = '<strong>AI:</strong> ';
        chatHistoryDiv.appendChild(aiResponseElement);

        function readStream() {
            reader.read().then(({ done, value }) => {
                if (done) {
                    chatHistory.push({"role": "user", "content": query});
                    chatHistory.push({"role": "assistant", "content": aiResponse});
                    return;
                }
                const chunk = decoder.decode(value);
                aiResponse += chunk;
                aiResponseElement.innerHTML = '<strong>AI:</strong> ' + formatResponse(aiResponse);
                readStream();
            });
        }

        readStream();
    })
    .catch((error) => {
        console.error('Error:', error);
    });
    
    document.getElementById('query').value = '';
});
</script>
{% endblock %}
